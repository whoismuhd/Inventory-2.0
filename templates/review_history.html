{% extends "base.html" %}

{% block content %}
<style>
    .review-history-page {
        padding: 2rem;
    }
    
    .section-card {
        background-color: var(--card-bg, #ffffff);
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-color, #212529);
    }
    
    .info-alert {
        background-color: var(--info-bg, #dbeafe);
        border: 1px solid var(--info-border, #2563eb);
        color: var(--info-text, #1e40af);
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }
    
    .request-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border-color, #dee2e6);
        margin-bottom: 1.5rem;
    }
    
    .request-tab {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        color: var(--text-muted, #6c757d);
        cursor: pointer;
        font-size: 1rem;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    
    .request-tab.active {
        color: var(--primary-color, #667eea);
        border-bottom-color: var(--primary-color, #667eea);
        font-weight: 600;
    }
    
    .request-tab:hover {
        color: var(--text-color, #212529);
    }
    
    .id-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .id-button {
        background-color: var(--card-bg, #ffffff);
        border: 1px solid var(--border-color, #dee2e6);
        color: var(--text-color, #212529);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
    }
    
    .id-button:hover {
        background-color: var(--hover-bg, #f8f9fa);
    }
    
    .form-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .form-group {
        flex: 1;
        min-width: 150px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-color, #212529);
        font-size: 0.9rem;
    }
</style>

<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-clock-history"></i> Review & History</h2>
    
    <!-- Filter by Status Section -->
    <div class="section-card">
        <label class="section-title" for="statusFilter">Filter by status</label>
        <form method="GET" action="{{ url_for('review_history') }}" id="statusFilterForm">
            <select class="form-select" id="statusFilter" name="status_filter" onchange="this.form.submit()" style="max-width: 300px;">
                <option value="All" {% if status_filter == 'All' or not status_filter %}selected{% endif %}>All</option>
                <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                <option value="Approved" {% if status_filter == 'Approved' %}selected{% endif %}>Approved</option>
                <option value="Rejected" {% if status_filter == 'Rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </form>
        
        {% if not requests.items %}
        <div class="info-alert">
            No requests found matching the selected criteria.
        </div>
        {% endif %}
    </div>
    
    {% if is_admin %}
    <!-- Approve/Reject a Request by ID Section -->
    <div class="section-card">
        <div class="section-title">Approve/Reject a request by ID:</div>
        <form method="POST" action="{{ url_for('approve_reject_by_id') }}" class="form-row">
            <div class="form-group">
                <label for="requestId">Request ID</label>
                <div class="id-controls">
                    <button type="button" class="id-button" onclick="decrementRequestId()">-</button>
                    <input type="number" class="form-control" id="requestId" name="request_id" value="1" min="1" required style="width: 80px; text-align: center;">
                    <button type="button" class="id-button" onclick="incrementRequestId()">+</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="actionType">Action</label>
                <select class="form-select" id="actionType" name="action" required>
                    <option value="approve">Approve</option>
                    <option value="reject">Reject</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="approvedBy">Approved by / Actor</label>
                <input type="text" class="form-control" id="approvedBy" name="approved_by" value="{{ session.user_name or '' }}" placeholder="Enter name">
            </div>
            
            <div class="form-group" style="display: flex; align-items: end;">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </form>
    </div>
    {% endif %}
    
    <!-- Complete Request Management Section -->
    <div class="section-card">
        <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 1rem;">Complete Request Management</h2>
        
        <!-- Tabs -->
        <div class="request-tabs">
            <button class="request-tab {% if active_tab == 'approved' %}active{% endif %}" onclick="switchTab('approved')">
                Approved Requests
            </button>
            <button class="request-tab {% if active_tab == 'rejected' %}active{% endif %}" onclick="switchTab('rejected')">
                Rejected Requests
            </button>
            <button class="request-tab {% if active_tab == 'deleted' %}active{% endif %}" onclick="switchTab('deleted')">
                Deleted Requests
            </button>
        </div>
        
        <!-- Tab Content -->
        <div>
            {% if active_tab == 'approved' %}
                <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">Approved Requests</h3>
                {% if approved_requests %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Time</th>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Total Price</th>
                                    <th>Requested By</th>
                                    <th>Project Site</th>
                                    <th>Building Type & Budget</th>
                                    <th>Approved By</th>
                                    {% if is_admin %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in approved_requests %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                    <td>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ req.item.name }}</td>
                                    <td>{{ req.qty }}</td>
                                    <td>{{ (req.qty * (req.current_price or req.item.unit_cost or 0))|format_currency }}</td>
                                    <td>{{ req.requested_by }}</td>
                                    <td>{{ req.project_site or '-' }}</td>
                                    <td>{{ req.building_type or '-' }} - {{ req.budget or '-' }}</td>
                                    <td>{{ req.approved_by or '-' }}</td>
                                    {% if is_admin %}
                                    <td>
                                        <a href="{{ url_for('delete_request', request_id=req.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this request?')">
                                            <i class="bi bi-trash"></i> Delete
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="info-alert">
                        No approved requests found.
                    </div>
                {% endif %}
                
            {% elif active_tab == 'rejected' %}
                <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">Rejected Requests</h3>
                {% if rejected_requests %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Time</th>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Total Price</th>
                                    <th>Requested By</th>
                                    <th>Project Site</th>
                                    <th>Building Type & Budget</th>
                                    <th>Rejected By</th>
                                    {% if is_admin %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in rejected_requests %}
                                <tr>
                                    <td>{{ req.id }}</td>
                                    <td>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ req.item.name }}</td>
                                    <td>{{ req.qty }}</td>
                                    <td>{{ (req.qty * (req.current_price or req.item.unit_cost or 0))|format_currency }}</td>
                                    <td>{{ req.requested_by }}</td>
                                    <td>{{ req.project_site or '-' }}</td>
                                    <td>{{ req.building_type or '-' }} - {{ req.budget or '-' }}</td>
                                    <td>{{ req.approved_by or '-' }}</td>
                                    {% if is_admin %}
                                    <td>
                                        <a href="{{ url_for('delete_request', request_id=req.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this request?')">
                                            <i class="bi bi-trash"></i> Delete
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="info-alert">
                        No rejected requests found.
                    </div>
                {% endif %}
                
            {% elif active_tab == 'deleted' %}
                <h3 class="section-title" style="font-size: 1.1rem; margin-bottom: 1rem;">Deleted Requests</h3>
                <div class="info-alert">
                    Deleted requests are permanently removed and cannot be recovered. This section shows recently deleted requests from the current session.
                </div>
                <div class="info-alert">
                    No deleted requests to display.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function incrementRequestId() {
    const input = document.getElementById('requestId');
    input.value = parseInt(input.value) + 1;
}

function decrementRequestId() {
    const input = document.getElementById('requestId');
    const value = parseInt(input.value);
    if (value > 1) {
        input.value = value - 1;
    }
}

function switchTab(tab) {
    const url = new URL(window.location.href);
    url.searchParams.set('tab', tab);
    window.location.href = url.toString();
}
</script>
{% endblock %}
